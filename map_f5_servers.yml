---
- name: Get networkmap details
  include_tasks: get_networkmap_details.yml

- set_fact:
    dgInfo: "{{ get_networkmap |json_query('json.dgInfo')|to_json |from_json  }}"

- debug:
    msg: "{{ dgInfo }}"

- set_fact:
     f5pripttid: "{{ dgInfo | json_query(f5priqry) | first }}"
     f5geopttid: "{{ dgInfo | json_query(f5geoqry) | first }}"
     f5priname: "{{ dgInfo | json_query(f5pri) | first }}"
     f5geoname: "{{ dgInfo | json_query(f5geo) | first }}"
  vars:
     f5priqry: "[? DGID == '710' ].cardDetails[]|[? CLUSTERID == '1' && SIGNALINGCARDTYPE == `101` ].PTTSERVERID"
     f5geoqry: "[? DGID == '711' ].cardDetails[]|[? CLUSTERID == '2' && SIGNALINGCARDTYPE == `101` ].PTTSERVERID"
     f5pri: "[? DGID == '710' ].cardDetails[]|[? CLUSTERID == '1' && SIGNALINGCARDTYPE == `101` ].SIGNALINGCARD_NAME"
     f5geo: "[? DGID == '711' ].cardDetails[]|[? CLUSTERID == '2' && SIGNALINGCARDTYPE == `101` ].SIGNALINGCARD_NAME"



- set_fact:
    media_map: >
          {"f5list":[
                 {"context":"F5_GEOMATE_MAP","action":"F5_GEOMATE_MAP_ADD","actionObject":{"PRI_F5_PTTSERVERID":"{{ f5pripttid }}","GEO_F5_PTTSERVERID":"{{ f5geopttid }}"}}
            ]}

#***** {{ media_index }} AA {{ ifc.apn }} BBB {{ primed_qery }} CCC {{ geomed_qery }} DDD

- debug:
    msg: "{{ media_map }}"

- name: F5_GEOMATE_MAP_ADD
  uri:
     url: "http://{{ cms.url }}/cms/config?v=1618385170120"
     method: POST
     headers:
       Connection: 'keep-alive'
       Authorization: 'Bearer {{ cms_login_token }} '
       Accept: 'application/json, text/plain, */*'
     validate_certs: no
     body: "{{ item }}"
     body_format: json
  register: get_data_by_nwmap
  with_items: "{{ media_map | json_query('f5list[]') }}"
  when: dry_run == 1
  failed_when: get_data_by_nwmap.status not in [200, 201]


- name: IPNETWORKPLANEMAPPINGINFO_GETALL
  uri:
     url: "http://{{ cms.url }}/cms/networkmap?v=1620732259069"
     method: POST
     headers:
       Connection: 'keep-alive'
       Authorization: 'Bearer {{ cms_login_token }} '
       Accept: 'application/json, text/plain, */*'
     validate_certs: no
     body: '{"context":"F5_APPSERVERMAP","action":"F5_APPSERVERMAP_GETALL","object":{"":""}}'
     body_format: json
     status_code: 200
  register: f5_map
  failed_when: f5_map.status not in [200]

- set_fact:
    f5_details: "{{ f5_map| to_json | from_json | json_query('json.data')}}"

- debug:
    msg: "{{ f5_details }}"


- set_fact:
    f5_app_map: >
          {"f5applist":[
            {% for applist in f5_details.additionalData3 %}
             {% for cnt,n in applist.iteritems() %}
              {% for k in n %}              
               {% set card_id = cnt.split('_')[1] %}
               {% set ptt_id = k.split('_')[1] %} 
                 {"context":"F5_APPSERVERMAP","action":"F5_APPSERVERMAP_ADD","actionObject":{"PTTSERVERID":"{{ ptt_id }}","SIGNALINGCARDTYPE":{{ card_id }},"SUBNET":0,"SIGNALINGCARD_NAME":"{{ k }}","F5_PRIMARY":"{{ f5priname }}_{{ f5pripttid }}","F5_GEO":"{{ f5geoname }}_{{ f5geopttid }}","F5_PTTSERVERID":"{{ f5pripttid }}","F5_ACCESSNWTYPE":0},"object":{"":""}},
              {% endfor %}  
             {% endfor %}
            {% endfor %}
            ]}



- debug:
    msg: "{{ f5_app_map }}"

- name: F5_APPSERVERMAP_ADD
  uri:
     url: "http://{{ cms.url }}/cms/config?v=1618385170120"
     method: POST
     headers:
       Connection: 'keep-alive'
       Authorization: 'Bearer {{ result.json.accessToken }} '
       Accept: 'application/json, text/plain, */*'
     validate_certs: no
     body: "{{ item }}"
     body_format: json
  register: get_data_by_nwmap
  with_items: "{{ f5_app_map | json_query('f5applist[]') }}"
  when: dry_run == 0
  failed_when: get_data_by_nwmap.status not in [200, 201]

