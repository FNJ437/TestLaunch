---
- name: get ems contianer name
  shell: docker ps | grep -i emsprimary | awk -F ' ' '{print $NF}'
  register: ems_container_name
  delegate_to: "{{ EMS }}"
  become: true

- debug:
    msg: "{{ems_container_name.stdout}}"

- fail: msg="Failed to get EMS containername"
  when: ems_container_name.stdout is not defined or ems_container_name.stdout == ''

- name: Copy UpdateContainerConfigValuesForSGSGRCBS.sh file to EMS VM host mounted path for Pinning CBS SW SWR and GG
  copy:
    src: "/DG/activeRelease/GenerateConfFiles/UpdateContainerConfigValuesForSGSGRCBS.json"
    dest: "/DGdata/Software/"
  delegate_to: "{{ EMS }}"
  become: true

- name: Copy UpdateContainerConfigValuesForSGSGRCBS.json file to EMS VM to Container path for Pinning CBS SW SWR and GG
  command: docker exec {{ ems_container_name.stdout }} bash -c "cp -f /Software/UpdateContainerConfigValuesForSGSGRCBS.json /DG/activeRelease/Tools/UpdateContainerConfigValuesForSGSGRCBS.json && chmod 755 /DG/activeRelease/Tools/UpdateContainerConfigValuesForSGSGRCBS.json && chown root:kodiakgroup /DG/activeRelease/Tools/UpdateContainerConfigValuesForSGSGRCBS.json"
  delegate_to: "{{ EMS }}"
  become: true

- name: execute pinning command 
  shell: docker exec {{ ems_container_name.stdout }} bash -c "sh /DG/activeRelease/Tools/UpdateContainerConfigValuesForSGSGRCBS.sh -PinningOption=MEMORY,CPU"
  delegate_to: "{{ EMS }}"
  become: true

- name: update the task in status file
  lineinfile:
      path: "{{status_file}}"
      line: "pinning"




