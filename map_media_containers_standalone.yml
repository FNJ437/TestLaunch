---
- name: Get networkmap details
  include_tasks: get_networkmap_details.yml

- set_fact:
    dgInfo: "{{ get_networkmap |json_query('json.dgInfo')|to_json |from_json  }}"

- debug:
    msg: "{{ dgInfo }}"

- set_fact:
    media_map: >
          {"medialist":[
              {% set media_index = 0 %}
              {% for nw in legacy %}
               {% for ip in nw.containers %}
                 {% if ip.sigcardid|int == 38 and nw.clusterid|int == 1 %}
                  {% set primed = "[? DGID == '" + ip.dgid + "' ].cardDetails[]|[? CLUSTERID == '1' && SIGNALINGCARDTYPE == `38` ].PTTSERVERID" %}
                  {% set pri_med = dgInfo | json_query(primed) | first | default(None)%}
                  {% set pocid = "[? DGID == '" + ip.dgid + "' ].cardDetails[]|[? CLUSTERID == '1' && SIGNALINGCARDTYPE == `38` ].PARENTPTTSERVERID" %}
                  {% set poc_pttserverid = dgInfo | json_query(pocid) | first %} 
                  {% set media_index  = media_index + 1 %}
                  {"context":"POC_MS_MAP","action":"POC_MS_MAP_ADD","actionObject":{"MEDIASERVERNAME":"{{ ip.name }}","PRIMARY_MS_PTTSERVERID":"{{ pri_med }}","GEO_MS_PTTSERVERID": "\"\"", "PTTSERVERID":"{{ poc_pttserverid }}"},"object":{"dgId": "{{ ip.pocdgid }}" }},
                 {% endif %}
                {% endfor %}
              {% endfor %}
            ]}

- debug:
    msg: "{{ media_map }}"

- name: Map media containers
  uri:
     url: "http://{{ cms.url }}/cms/config?v=1618385170120"
     method: POST
     headers:
       Connection: 'keep-alive'
       Authorization: 'Bearer {{ result.json.accessToken }} '
       Accept: 'application/json, text/plain, */*'
     validate_certs: no
     body: "{{ item }}"
     body_format: json
  register: get_data_by_nwmap
  with_items: "{{ media_map | json_query('medialist[]') }}"
  when: dry_run == 0
  failed_when: get_data_by_nwmap.status not in [200, 201]

