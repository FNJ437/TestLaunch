---
- name: Get networkmap details
  include_tasks: get_networkmap_details.yml

- set_fact:
    poc_servers: >
     {% for server in get_networkmap.json.dgInfo %}{% if server.CARDTYPE == 32 or server.CARDTYPE == 33 %}{{server}},{% endif %}{% endfor %}

    media_servers: >
     {% for server in get_networkmap.json.dgInfo %}{% if server.CARDTYPE == 38 or server.CARDTYPE == 39 %}{{server}},{% endif %}{% endfor %}

- debug:
    msg: "{{ poc_servers }}"

- debug:
    msg: "{{ media_servers }}"

- set_fact:
    number_of_media: >
      {
        {% for poc in poc_servers %}
          {% set vars = {"max_media": 0} %}
          {% for media in poc.mediaCardDetails %}
            {% if media.HOSTNAME[-1] | int > vars.max_media %}
              {% if vars.update({"max_media": media.HOSTNAME[-1] | int}) %}{% endif %}
            {% endif %}
          {% endfor %}
          {{ poc.DGID | int }}: {{vars.max_media}},
        {% endfor %}
      }

- debug:
    msg: "{{ number_of_media }}"

- set_fact:
    media_map: >
      {"medialist":[
        {% for poc in poc_servers %}
          {% for i in range(number_of_media[ poc.DGID | int ])%}
            {% set pri_qry = "[?contains(HOSTNAME, 'MEDIA" + (i+1)|string + "')&& contains(HOSTNAME, 'P')  && SIGNALINGCARDTYPE == `38` ]"  %}
            {% set pri_media = poc.mediaCardDetails | to_json | from_json | json_query(pri_qry) %}
            {% set geo_qry = "[?contains(HOSTNAME, 'MEDIA" + (i+1)|string + "') && contains(HOSTNAME, 'G')  && SIGNALINGCARDTYPE == `38` ]"  %}
            {% set geo_media = poc.mediaCardDetails | to_json | from_json | json_query(geo_qry) %}
            {% set sec_qry = "[?contains(HOSTNAME, 'MEDIA" + (i+1)|string + "') && contains(HOSTNAME, 'K')  && SIGNALINGCARDTYPE == `39` ]"  %}
            {% set sec_media = poc.mediaCardDetails | to_json | from_json | json_query(sec_qry) %}
            {% if sec_media != [] and geo_media != [] and pri_media != []%}
              {
                "context":"POC_MS_MAP",
                "action":"POC_MS_MAP_ADD",
                "actionObject":{
                  "MEDIASERVERNAME":"{{ pri_media[0].SIGNALINGCARD_NAME }}",
                  "PRIMARY_MS_PTTSERVERID":"{{ pri_media[0].PTTSERVERID }}",
                  "PTTSERVERID":"{{ pri_media[0].PARENTPTTSERVERID }}",
                  "GEO_MS_PTTSERVERID": "{{ geo_media[0].PTTSERVERID }}",
                },
                "object":{"dgId": "{{ poc.DGID }}",}
              },
              {
                "context":"POC_MS_MAP",
                "action":"POC_MS_MAP_ADD",
                "actionObject":{
                  "MEDIASERVERNAME":"{{ pri_media[0].SIGNALINGCARD_NAME }}",
                  "PRIMARY_MS_PTTSERVERID":"{{ sec_media[0].PTTSERVERID }}",
                  "PTTSERVERID":"{{ pri_media[0].PARENTPTTSERVERID }}",
                  "GEO_MS_PTTSERVERID": "",
                },
                "object":{"dgId": "{{ poc.DGID }}",}
              },

            {% elif geo_media != [] and pri_media != [] %}
              {
                "context":"POC_MS_MAP",
                "action":"POC_MS_MAP_ADD",
                "actionObject":{
                  "MEDIASERVERNAME":"{{ pri_media[0].SIGNALINGCARD_NAME }}",
                  "PRIMARY_MS_PTTSERVERID":"{{ pri_media[0].PTTSERVERID }}",
                  "PTTSERVERID":"{{ pri_media[0].PARENTPTTSERVERID }}",
                  "GEO_MS_PTTSERVERID": "{{ geo_media[0].PTTSERVERID }}",
                },
                "object":{"dgId": "{{ poc.DGID }}",}
              },

            {% elif pri_media != [] %}
              {
                "context":"POC_MS_MAP",
                "action":"POC_MS_MAP_ADD",
                "actionObject":{
                  "MEDIASERVERNAME":"{{ pri_media[0].SIGNALINGCARD_NAME }}",
                  "PRIMARY_MS_PTTSERVERID":"{{ pri_media[0].PTTSERVERID }}",
                  "PTTSERVERID":"{{ pri_media[0].PARENTPTTSERVERID }}",
                  "GEO_MS_PTTSERVERID": "",
                },
                "object":{"dgId": "{{ poc.DGID }}",}
              },
            {% endif %}
          {% endfor %}
        {% endfor %}
      ]}

- debug:
    msg: "{{ media_map }}"

- name: Map media containers
  uri:
    url: "http://{{ cms.url }}/cms/config?v=1618385170120"
    method: POST
    headers:
      Connection: 'keep-alive'
      Authorization: 'Bearer {{ result.json.accessToken }} '
      Accept: 'application/json, text/plain, */*'
    validate_certs: no
    body: "{{ item }}"
    body_format: json
  register: get_data_by_nwmap
  with_items: "{{ media_map | json_query('medialist[]') }}"
  failed_when: get_data_by_nwmap.json.code | int not in [200, 201]

- debug:
    msg: "{{ get_data_by_nwmap |json_query('results[*].json')|to_json |from_json }}"

- name: update the task in status file
  lineinfile:
      path: "{{status_file}}"
      line: "map_media_containers"
